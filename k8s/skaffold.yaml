apiVersion: skaffold/v2beta29
kind: Config
metadata:
  name: omni-order-project

# 1. 빌드 설정
build:
  # 태그 정책: 로컬 개발 시에는 git 대신 sha256을 쓰거나 기본값을 쓰는 게 정신건강에 좋습니다.
  # 여기서는 기본 로컬 개발 설정을 따르도록 명시적인 tagPolicy를 제거하거나 간단히 둡니다.
  local:
    push: false # 로컬 쿠버네티스(Docker Desktop/Minikube) 사용 시 이미지를 레지스트리에 푸시하지 않음

  artifacts:
    # Order Service
    - image: creamdocker/order-service
      context: ../order-service # skaffold.yaml이 있는 폴더의 상위(../)로 가서 찾음
      docker:
        dockerfile: Dockerfile

    # Product Service
    - image: creamdocker/product-service
      context: ../product-service
      docker:
        dockerfile: Dockerfile

# 2. 배포 설정
deploy:
  # 1. 애플리케이션은 Helm으로 배포
  helm:
    releases:
      - name: my-order-release
        chartPath: order-chart
        # Skaffold가 빌드한 이미지를 values.yaml의 'image' 키에 덮어씌웁니다.
        artifactOverrides:
          image: creamdocker/order-service

      - name: my-product-release
        chartPath: product-chart
        artifactOverrides:
          image: creamdocker/product-service

  # 2. 나머지 인프라(DB, Redis, 등)는 기존처럼 kubectl로 배포 (하이브리드 방식)
  kubectl:
    manifests:
      - "eureka-deployment.yaml"
      - "ingress.yaml"
      - "*-deployment.yaml" # 주의: order랑 product는 이미 Helm으로 했으니 제외해야 함!
      # 하지만 와일드카드(*)를 쓰면 중복 배포될 위험이 있습니다.
      # 안전하게 아래처럼 필요한 파일만 명시하는 것을 추천합니다.
      - "database-deployment.yaml"
      - "redis-deployment.yaml"
      - "eureka-deployment.yaml"

      # order랑 product의 deployment.yaml은 여기서 목록에 넣지 않습니다!